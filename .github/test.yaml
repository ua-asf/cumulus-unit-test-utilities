name: Unit Test

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: 3.11

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install tox~=4.15 coverage

    - run: tox

    - name: Report Coverage Status
      uses: actions/github-script@v7
      env:
        SHA: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
      with:
        script: |
          let report = async (covFile, checkName) => {
            const fs = require('fs')
            const covData = fs.readFileSync(covFile)
            var coverage = JSON.parse(covData)

            const { SHA } = process.env

            let coverageReport = '';
            await exec.exec(
              'coverage',
              ['report', '--show-missing', '--format=markdown'],
              {
                listeners: {
                  stdout: (data) => {
                    coverageReport += data.toString()
                  }
                }
              },
            )

            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: checkName,
              head_sha: SHA,
              conclusion: 'success',
              output: {
                title: `Total coverage: ${coverage.totals.percent_covered_display}%`,
                summary: coverageReport,
              },
            })
          }

          await report('sort-json.json', 'sort-json Code Coverage')
          await report('tracked-dict.json', 'tracked-dict Code Coverage')
